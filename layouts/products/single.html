{{ define "main" }}

<style>
/* Card chọn class */
.class-card {
  padding: 12px;
  border: 1px solid #334155;
  border-radius: 12px;
  background: #0f172a;
  cursor: pointer;
  transition: 0.2s ease;
}
.class-card:hover {
  border-color: #22d3ee;
  transform: translateY(-3px);
  box-shadow: 0 0 12px #22d3ee55;
}
.class-card.selected {
  border-color: #22d3ee;
  background: #1e293b;
  box-shadow: 0 0 18px #22d3eeaa;
}
.class-thumb {
  width: 100%;
  border-radius: 10px;
  margin-bottom: 8px;
}

/* === POPUP Overlay === */
#class-popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

/* Popup box */
#class-popup-content {
  background: #0f172a;
  border: 1px solid #22d3ee;
  border-radius: 12px;
  padding: 24px;
  max-width: 760px;
  width: 90%;
  display: flex;
  gap: 24px;
}

/* Popup image */
#class-popup-content img {
  width: 230px;
  border-radius: 12px;
  object-fit: cover;
}

/* Close button */
#popup-close {
  margin-top: 16px;
  background: #22d3ee;
  color: black;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
}
</style>

<article class="space-y-6">
  <h1 class="text-3xl font-semibold">{{ .Title }}</h1>

  <div class="grid md:grid-cols-2 gap-6">
      <div>
          {{ with .Params.image }}
          <img src="{{ . }}" class="rounded-lg border border-slate-800"/>
          {{ end }}
      </div>

      <div class="space-y-4">
          <div class="text-slate-300 text-sm">{{ .Params.summary }}</div>

          <!-- Giá thay đổi khi chọn class -->
          <div id="price-display" class="text-xl font-mono text-cyan-400">
            Hãy chọn lớp nhân vật để xem giá
          </div>

          <!-- Chọn class -->
          <div class="text-sm text-slate-300">Chọn lớp nhân vật:</div>
          <div id="class-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

          <button id="btn-add" class="bg-cyan-500 text-black px-4 py-2 rounded hover:bg-cyan-400">
              + Thêm vào giỏ
          </button>

          <a href="/cart/" class="block text-sm underline">Xem giỏ hàng →</a>
      </div>
  </div>

  <div class="prose prose-invert max-w-none">{{ .Content }}</div>
</article>

<!-- === POPUP === -->
<div id="class-popup">
  <div id="class-popup-content">
    <img id="popup-img" src="" alt="">

    <div>
      <h2 id="popup-name" class="text-xl font-semibold"></h2>
      <p id="popup-description" class="text-slate-300 mt-2"></p>

      <div class="mt-3">
        <h3 class="font-semibold text-cyan-300">Kỹ năng nổi bật:</h3>
        <ul id="popup-skills" class="list-disc ml-5 text-slate-300"></ul>
      </div>

      <button id="popup-close">Đóng</button>
    </div>
  </div>
</div>

<script>
const CLASSES = {{ .Params.classes | jsonify | safeJS }};
const priceDisplay = document.getElementById("price-display");
const classList = document.getElementById("class-list");
let selected = null;

// Mở popup
function openPopup(cls){
  document.getElementById("popup-img").src = cls.image || "";
  document.getElementById("popup-name").textContent = cls.name;
  document.getElementById("popup-description").textContent = cls.description || "";

  const skillList = document.getElementById("popup-skills");
  skillList.innerHTML = "";
  (cls.skills || []).forEach(s => {
      const li = document.createElement("li");
      li.textContent = s;
      skillList.appendChild(li);
  });

  document.getElementById("class-popup").style.display = "flex";
}

document.getElementById("popup-close").onclick = () =>
  document.getElementById("class-popup").style.display = "none";

// Render danh sách class
function renderClasses(){
  classList.innerHTML = "";
  CLASSES.forEach(cls => {
    const card = document.createElement("div");
    card.className = "class-card";
    card.innerHTML = `
      <img src="${cls.image}" class="class-thumb">
      <div class="text-lg font-semibold">${cls.name}</div>
      <div class="text-sm text-slate-400">${cls.description || ""}</div>
      <div class="text-sm font-mono text-cyan-400 mt-1">${Number(cls.price||0).toLocaleString("vi-VN")}đ</div>
    `;

    card.onclick = () => {
      selected = cls;
      priceDisplay.textContent = Number(cls.price||0).toLocaleString("vi-VN") + "đ";
      document.querySelectorAll(".class-card").forEach(c => c.classList.remove("selected"));
      card.classList.add("selected");
      openPopup(cls);
    };

    classList.appendChild(card);
  });
}

document.getElementById("btn-add").onclick = () => {
  if(!selected){
    alert("Hãy chọn lớp nhân vật trước khi thêm vào giỏ!");
    return;
  }

  addToCart({
    sku: '{{ .File.BaseFileName }}',
    name: '{{ .Title }}',
    price: Number(selected.price || 0),
    image: '{{ .Params.image | default "" }}',
    options: { "Lớp nhân vật": selected.name }
  });
};

renderClasses();
</script>

{{ end }}
