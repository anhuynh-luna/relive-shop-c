{{ define "main" }}

<h1 class="text-2xl font-semibold mb-6 text-white">Gi·ªè h√†ng üõçÔ∏è</h1>

<div id="cart-empty" class="text-slate-300 hidden">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</div>

<div id="cart-summary" class="hidden">

  <div id="cart-items" class="space-y-4"></div>

  <div class="mt-6 p-4 border border-slate-700 rounded-xl">
    <div class="flex justify-between text-slate-300">
      <span>T·∫°m t√≠nh:</span>
      <span id="cart-subtotal" class="font-mono"></span>
    </div>

    <div id="voucher-row" class="flex justify-between text-cyan-300 mt-1 hidden">
      <span>Gi·∫£m gi√°:</span>
      <span id="voucher-amount" class="font-mono"></span>
    </div>

    <div class="flex justify-between text-white text-lg font-semibold mt-2">
      <span>T·ªïng thanh to√°n:</span>
      <span id="cart-total" class="font-mono"></span>
    </div>

    <div class="mt-6 flex gap-3">
      <button onclick="clearCart()" class="px-3 py-2 border border-slate-700 rounded hover:bg-slate-800 text-slate-200">
        X√≥a gi·ªè
      </button>

      <button onclick="startCheckout()" class="px-3 py-2 bg-cyan-500 text-black rounded hover:bg-cyan-400">
        Thanh to√°n ‚Üí
      </button>
    </div>
  </div>
</div>

<!-- GACHA MODAL -->
<div id="gacha-modal" class="fixed inset-0 hidden bg-black/70 flex items-center justify-center z-50">
  <div class="bg-slate-900 p-6 rounded-xl w-[420px] text-center border border-cyan-500/40 shadow-[0_0_25px_rgba(0,255,255,0.25)] relative">

    <button onclick="closeGacha()" class="absolute top-2 right-3 text-slate-300 hover:text-white">‚úï</button>

    <h2 class="text-xl font-semibold text-cyan-300 mb-4">‚ú® B·ªëc thƒÉm may m·∫Øn</h2>
    <p class="text-slate-300 text-sm mb-4">Ch·ªçn m·ªôt trong ba l√° b√†i b√™n d∆∞·ªõi:</p>

    <div class="flex justify-center gap-6">
      
      <div class="gacha-card" onclick="pickCard(0)">üé¥</div>
      <div class="gacha-card" onclick="pickCard(1)">üé¥</div>
      <div class="gacha-card" onclick="pickCard(2)">üé¥</div>

    </div>

    <div id="gacha-result" class="text-cyan-300 mt-5 text-lg font-semibold hidden"></div>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div id="payment-modal" class="fixed inset-0 hidden bg-black/70 flex items-center justify-center z-50">
  <div class="bg-slate-800 p-6 rounded-xl w-[380px] relative">

    <button onclick="closePaymentModal()" class="absolute top-2 right-3 text-slate-300 hover:text-white">‚úï</button>

    <h2 class="text-xl font-semibold text-white text-center mb-4">Thanh to√°n</h2>

    <select id="payment-method" class="w-full p-2 bg-slate-900 rounded border border-slate-600 mb-3 text-white">
      <option value="">-- Ch·ªçn ph∆∞∆°ng th·ª©c --</option>
      <option value="Momo">V√≠ MoMo</option>
      <option value="ZaloPay">ZaloPay</option>
      <option value="Card">Th·∫ª ng√¢n h√†ng</option>
    </select>

    <input id="account-name" type="text" placeholder="T√™n ch·ªß t√†i kho·∫£n" class="w-full p-2 bg-slate-900 rounded border border-slate-600 mb-3 text-white">
    <input id="account-number" type="text" placeholder="S·ªë t√†i kho·∫£n / S·ªë v√≠" class="w-full p-2 bg-slate-900 rounded border border-slate-600 mb-4 text-white">

    <label class="flex items-start text-xs text-slate-300 gap-2 mb-3">
      <input id="agree-terms" type="checkbox" class="accent-cyan-400 mt-1">
      T√¥i ƒë·ªìng √Ω v·ªõi
      <a href="/privacy/" class="underline text-cyan-400">Ch√≠nh s√°ch b·∫£o m·∫≠t</a> v√†
      <a href="/terms/" class="underline text-cyan-400">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>.
    </label>

    <div id="payment-error" class="text-red-400 text-center text-sm hidden mb-3">Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin.</div>

    <div class="flex justify-between">
      <button onclick="closePaymentModal()" class="px-3 py-2 border border-slate-700 rounded hover:bg-slate-700 text-slate-200">H·ªßy</button>
      <button onclick="confirmPayment()" class="px-3 py-2 bg-green-500 rounded hover:bg-green-400 text-black">X√°c nh·∫≠n</button>
    </div>

  </div>
</div>

<style>
.gacha-card {
  width: 90px; height: 130px;
  background: linear-gradient(135deg, #1e293b, #0f172a);
  border: 2px solid rgba(0,255,255,0.4);
  box-shadow: 0 0 18px rgba(0,255,255,0.35);
  border-radius: 10px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  font-size: 32px;
  transition: 0.25s;
}
.gacha-card:hover { transform: scale(1.12); box-shadow: 0 0 28px rgba(0,255,255,0.55); }
</style>

<script>
function getCart(){ return JSON.parse(localStorage.getItem("cart") || "[]"); }
function saveCart(c){ localStorage.setItem("cart", JSON.stringify(c)); }

function getVoucher(){ return JSON.parse(localStorage.getItem("voucher") || '{"spun":false,"amount":0}'); }
function saveVoucher(v){ localStorage.setItem("voucher", JSON.stringify(v)); }

function renderCart(){
  const cart = getCart();
  const voucher = getVoucher();
  const subtotal = cart.reduce((t,i)=>t + Number(i.price||0),0);
  const discount = Math.min(subtotal, voucher.amount);

  document.getElementById("cart-empty").classList.toggle("hidden", cart.length !== 0);
  document.getElementById("cart-summary").classList.toggle("hidden", cart.length === 0);

  const itemsDiv = document.getElementById("cart-items");
  itemsDiv.innerHTML = "";

  cart.forEach((item, idx)=>{
    itemsDiv.innerHTML += `
      <div class="flex items-center justify-between border-b border-slate-700 py-2">
        <div class="flex gap-3">
          <img src="${item.image}" class="w-20 h-20 object-cover rounded border border-slate-700" />
          <div>
            <div class="font-semibold text-white">${item.name}</div>
            <div class="text-xs text-slate-400">L·ªõp: ${item.options?.["L·ªõp nh√¢n v·∫≠t"]}</div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-white">${Number(item.price).toLocaleString("vi-VN")}ƒë</div>
          <button onclick="removeItem(${idx})" class="text-xs text-red-400 hover:text-red-300">X√≥a</button>
        </div>
      </div>`;
  });

  document.getElementById("cart-subtotal").innerText = subtotal.toLocaleString("vi-VN")+"ƒë";
  document.getElementById("cart-total").innerText = (subtotal - discount).toLocaleString("vi-VN")+"ƒë";

  voucher.amount > 0
    ? (document.getElementById("voucher-row").classList.remove("hidden"),
       document.getElementById("voucher-amount").innerText = "-"+discount.toLocaleString("vi-VN")+"ƒë")
    : document.getElementById("voucher-row").classList.add("hidden");
}

function removeItem(idx){
  if(getVoucher().amount > 0){ alert("‚ùó Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m khi ∆∞u ƒë√£i ƒëang √°p d·ª•ng."); return; }
  const cart = getCart();
  cart.splice(idx,1);
  saveCart(cart);
  renderCart();
}

function clearCart(){
  if(getVoucher().amount > 0){ alert("‚ùó Kh√¥ng th·ªÉ x√≥a gi·ªè khi ∆∞u ƒë√£i ƒëang √°p d·ª•ng."); return; }
  saveCart([]);
  renderCart();
}

/* --- GACHA --- */
function startCheckout(){
  let voucher = getVoucher();
  let cart = getCart();
  if(cart.length===0){ alert("Gi·ªè h√†ng ƒëang tr·ªëng."); return; }

  if(!voucher.spun){
    openGacha(); return;
  }

  openPaymentModal();
}

function openGacha(){ document.getElementById("gacha-modal").classList.remove("hidden"); }
function closeGacha(){ document.getElementById("gacha-modal").classList.add("hidden"); }

function pickCard(){
  const prize = [0,50000,100000][Math.floor(Math.random()*3)];
  document.getElementById("gacha-result").innerText =
    (prize>0 ? `üéâ Gi·∫£m ${prize.toLocaleString("vi-VN")}ƒë` : "üò¢ Ch√∫c b·∫°n may m·∫Øn l·∫ßn sau!");
  document.getElementById("gacha-result").classList.remove("hidden");

  voucher = { spun:true, amount: prize };
  saveVoucher(voucher);

  setTimeout(()=>{ closeGacha(); renderCart(); openPaymentModal(); },1300);
}

/* --- THANH TO√ÅN --- */
function openPaymentModal(){ document.getElementById("payment-modal").classList.remove("hidden"); }

function closePaymentModal(){
  const v = getVoucher();
  if(v.spun && v.amount>0){
    if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy thanh to√°n?\nVoucher s·∫Ω b·ªã h·ªßy v√† kh√¥ng th·ªÉ quay l·∫°i.")){
      saveVoucher({spun:true,amount:0});
      document.getElementById("payment-modal").classList.add("hidden");
      renderCart();
    }
    return;
  }
  document.getElementById("payment-modal").classList.add("hidden");
}

function confirmPayment(){
  const method = document.getElementById("payment-method").value;
  const name = document.getElementById("account-name").value.trim();
  const number = document.getElementById("account-number").value.trim();
  const agree = document.getElementById("agree-terms").checked;
  const err = document.getElementById("payment-error");

  if(!method || !name || !number || !agree){
    err.classList.remove("hidden");
    return;
  }

  alert("‚ú® Thanh to√°n th√†nh c√¥ng!\nTr·∫£i nghi·ªám c·ªßa b·∫°n s·∫Ω b·∫Øt ƒë·∫ßu ngay üíó");
  clearCart();
  saveVoucher({spun:false, amount:0});
  closePaymentModal();
}

renderCart();
</script>

{{ end }}
